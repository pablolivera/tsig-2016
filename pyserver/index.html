<!DOCTYPE html>
<html>
<head>
    <meta charset=utf-8 />
    <title>Prototipo TSIG 2016 - neo4j - spatial</title>
    
    <!-- #########################################################
    
    FUENTE: https://github.com/legis-graph/legis-graph-spatial
    
    ######################################################### -->
    
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.mapbox.com/mapbox.js/v2.2.3/mapbox.js'></script>
    <link href='https://api.mapbox.com/mapbox.js/v2.2.3/mapbox.css' rel='stylesheet' />
    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
	<script src='https://api.mapbox.com/mapbox.js/plugins/mapbox-directions.js/v0.4.0/mapbox.directions.js'></script>
	<link rel='stylesheet' href='https://api.mapbox.com/mapbox.js/plugins/mapbox-directions.js/v0.4.0/mapbox.directions.css' type='text/css' />

    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:1px; bottom:0; width:100%; }

        #desc{
            position:absolute;
            margin-left:5px;
            margin-right: 5px;
            height: 100px;
            width:100%;

        }

        .committees {
            margin-left: 0px;
        }

        .heading {
            margin-top: 0px;
            margin-bottom: 0px;
            padding-top: 25px;
        }

        .top-row {
            background: lightgray;
        }

    </style>
</head>
<body>

<div id='map'></div>

<script>

    /**
     * Constants
     */
    var findGeometriesPath = '/db/data/ext/SpatialPlugin/graphdb/findGeometriesWithinDistance';
    var baseURI = 'http://localhost:7474';
    // Token que provee MapBox. Crear un cuenta en mapbox.com
    var MB_API_TOKEN = "pk.eyJ1IjoicGFibG9saXZlcmEiLCJhIjoiY2lvMjEyc2U4MWFvbHVnbHl4YTJncHlsNSJ9.D1k_wpA7LoXOyxCEK-1U6A";

    var subjectsQuery = "MATCH (d:District {state: {state}, district: {district}}) \n" +
            "MATCH (d)<-[:REPRESENTS]-(l:Legislator) \n" +
            "MATCH (l)-[:SERVES_ON]->(c:Committee) \n" +
            "MATCH (c)<-[:REFERRED_TO]-(b:Bill) \n" +
            "MATCH (b)-[:DEALS_WITH]->(s:Subject) \n" +
            "WITH l.govtrackID AS govtrackID, l.lastName AS lastName, l.firstName AS firstName, l.currentParty AS party, s.title AS subject, count(*) AS strength, collect(DISTINCT c.name) AS committees ORDER BY strength DESC LIMIT 10 \n" +
            "WITH {lastName: lastName, firstName: firstName, govtrackID: govtrackID, party: party, committees: committees} AS legislator, collect({subject: subject, strength: strength}) AS subjects \n" +
            "RETURN {legislator: legislator, subjects: subjects} AS r ";

    /**
     * Clears the map. Remove all currently shown layers
     * */
    function clearMap(m) {
        for(var i in m._layers) {
            if(m._layers[i]._path != undefined) {
                try {
                    m.removeLayer(m._layers[i]);
                }
                catch(e) {
                    console.log("problem with " + e + m._layers[i]);
                }
            }
        }
    }

    /**
     *  Converts Polygon WKT string to an array of [x,y] points
     */
    function parseWKTPolygon(wkt) {
        var pointArr = [];
        var points = wkt.slice(10, -3).split(",");

        $.each(points, function(i,v) {
            var point = $.trim(v).split(" ");
            var xy = [Number(point[1]), Number(point[0])];
            pointArr.push(xy)

        });

        return pointArr;
    }

    /**
     * Make an AJAX POST request
     */
    function makePOSTRequest(url, params, callback) {

        $.ajax({
            type: 'POST',
            data: JSON.stringify(params),
            contentType: 'application/json',
			headers: { "Authorization": "Basic bmVvNGo6cGFibDA" },
            url: url,
            error: function(xhr, statusText, errorThrown) {
                callback("Error", null);
            },
            success: function(data) {
                console.log(data);
                callback(null, data);
            }
        })
    }


    /**
     *  Find the Department for a given latlng.
     */
    function infoDepartmentWithinDistance(latlng, distance) {

        var params = {
            "layer": "geom",
            "pointX": latlng.lng,
            "pointY": latlng.lat,
            "distanceInKm": distance
        };
	console.log("lng " + latlng.lng + " - lat " + latlng.lat)

        var districtURL = baseURI + findGeometriesPath;
        makePOSTRequest(districtURL, params, function (error, data) {

            if (error) {
                console.log("Error");
            } else {
                console.log("Resultado: ");
				console.log(data);

                var points = parseWKTPolygon(data[0]["data"]["wkt"]);
				var districtInfo = [];
				districtInfo["points"] = points;
				districtInfo["info"] = data[0]["data"];
				addDistrictToMap(districtInfo, latlng);
            }
        });
    }

    /**
     *  Run a Cypher query
     */
    function makeCypherRequest(statements, callback) {

        var url = baseURI.replace(/\/db\/data.*/,"") + "/db/data/transaction/commit";

        $.ajax({
            type: 'POST',
            data: JSON.stringify({
                statements: statements
            }),
            contentType: 'application/json',
	    headers: { "Authorization": "Basic bmVvNGo6cGFibDA" },
            url: url,
            error: function(xhr, statusText, errorThrown){
                callback("Error", null);
            },
            //headers: authHeader(),
            success: function(data) {
                console.log(data);
                callback(null, data);

            }
        });
    }

    /**
     * Generate the content for the popup
     * @param d
     * @returns {string}
     */
    function buildPopup(d) {
/*
        var legislator = d["legislator"];
        var committees = legislator["committees"];
        var legislatorName = "Rep. " + legislator["firstName"] + " " + legislator["lastName"];
        var imgURL= "https://www.govtrack.us/data/photos/" + legislator["govtrackID"] + "-50px.jpeg";
        var subjects = d["subjects"];

        var text =
                '<ul class="nav nav-tabs" role="tablist">' +
                    '<li role="presentation" class="active"><a href="#home" aria-controls="home" role="tab" data-toggle="tab">Info</a></li>' +
                    '<li role="presentation"><a href="#code" aria-controls="code" role="tab" data-toggle="tab">Code</a></li>' +
                '</ul>' +
            '<div class="tab-content">' +
                '<div role="tabpanel" class="tab-pane active" id="home">' +

                    '<div class="row">' +
                        '<div class="col-xs-3">' +
                            '<img src="'+ imgURL + '">' +
                        '</div>' +
                        '<div class="col-xs-9">' +
                            '<ul class="list-unstyled">' +
                            '<li><strong>' + legislatorName + '</strong></li>' +
                            '<li>District: ' + d["district"] + '</li>' +
                            '<li>State: ' + d["state"] + '</li>' +
                        '</div>' +
                    '</div>' +

                    '<div class="row committees">' +
                        '<dl><dt>Committees</dt>';

                $.each(committees, function(i,v) {
                        text = text + '<dd>' + v + '</dd>';
                });
                   text = text +
                        '</dl>' +
                    '</div>' +

                    '<div class="row">' +
                        '<ul>';
                $.each(subjects, function(i,v) {
                    text = text + '<li>' + v["subject"] + " (" + v["strength"] + ")";
                });
                            text = text +
                        '</ul>' +
                    '</div>' +
                '</div>' +
            '<div role="tabpanel" class="tab-pane" id="code">' +
                '<pre class="pre-scrollable">' + subjectsQuery + '</pre>' +
            '</div>' +

        '</div>'
            ;

*/

		var text = 'Nombre: ' + d["info"]["d_nombre"] + '<br/>'; 
		text += 'Capital: ' + d["info"]["d_capital"] + '<br/>';
		text += 'Intendente: ' + d["info"]["d_intendente"] + '<br/>';
		text += 'Pob: ' + d["info"]["d_poblacion"] + '<br/>';
        return text; // text
    }

    /**
     *  Add District polygon and legislator popup to map
     *
     * @param data
     * @param latlng
     */
    function addDistrictToMap(data, latlng) {
        polygon_points = data["points"];

        popuptext = buildPopup(data);

        var polyline = L.polygon(polygon_points, {color: 'brown'}).addTo(map);
        map.fitBounds(polyline.getBounds());

        var popup = L.popup({keepInView: true, minWidth: 300, maxWidth: 1000});
        popup.setLatLng(latlng)
                .setContent(popuptext)
                .openOn(map);

        popup.update();

    }


    /**
     * Event handler for map click
     *
     * @param event
     */
    function getClosestDepartment(event) {
        infoDepartmentWithinDistance(event.latlng, 10);
    }

    L.mapbox.accessToken = MB_API_TOKEN;
    var map = L.mapbox.map('map', 'mapbox.streets')
            .setView([-32.8278, -55.9775], 7); // Setear latitud y longitud de inicio del mapa y el nivel del zoom.

    map.on('click', function(e) { // Asociar el evento click
        clearMap(map);
        getClosestDepartment(e);
    });

</script>
</body>
</html>